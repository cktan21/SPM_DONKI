name: Tests and Coverage (Combined)

on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - main
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
    cancel-in-progress: true

jobs:
    unit-tests:
        name: Python Unit Tests + Coverage
        runs-on: ubuntu-latest
        env:
            SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
            SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
            SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
            SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
            INTERNAL_API_KEY: ${{ secrets.INTERNAL_API_KEY }}
        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4

            - name: Install Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Cache Python dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install Python Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pytest pytest-cov coveralls supabase dotenv fastapi httpx pydantic uvicorn
                  pip install \
                    fastapi \
                    starlette \
                    pydantic \
                    httpx \
                    anyio \
                    uvicorn \
                    pytest \
                    pytest-cov \
                    pytest-asyncio \
                    python-dateutil \
                    apscheduler \
                    pytz \
                    kafka-python-ng

            - name: Run Unit Tests (pytest) with coverage
              run: |
                  pytest -v --cov=./backend/services/ \
                    --cov-report=term-missing \
                    --cov-report=xml:coverage-python.xml \
                    test/unit/

            - name: Upload Python coverage to Coveralls (parallel)
              uses: coverallsapp/github-action@v2
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  flag-name: python
                  parallel: true
                  file: coverage-python.xml
                  format: cobertura
              env:
                  COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}

    integration-tests:
        name: Go Integration Tests + Coverage
        runs-on: ubuntu-latest
        env:
            SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
            SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
            SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
            SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
            INTERNAL_API_KEY: ${{ secrets.INTERNAL_API_KEY }}
            SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
            SMTP_PORT: ${{ secrets.SMTP_PORT }}
            SMTP_USER: ${{ secrets.SMTP_USER }}
            SMTP_PASS: ${{ secrets.SMTP_PASS }}
        defaults:
            run:
                working-directory: ./backend
        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25"

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Start services (optimized)
              run: |
                  export DOCKER_BUILDKIT=1
                  export BUILDKIT_PROGRESS=plain
                  docker compose up -d --build
                  echo "Waiting for containers to start..."
                  timeout 120s bash -c 'until docker compose ps | grep -q "healthy\|Up"; do sleep 2; done'
                  echo "Containers are up, waiting for HTTP services to be ready..."

                  # Wait for actual HTTP health endpoints
                  wait_for_service() {
                      local url=$1
                      local max_attempts=60
                      local attempt=1
                      
                      echo "Waiting for $url..."
                      while [ $attempt -le $max_attempts ]; do
                          if curl -f -s --max-time 5 "$url" > /dev/null 2>&1; then
                              echo "‚úÖ $url is ready"
                              return 0
                          fi
                          sleep 2
                          attempt=$((attempt + 1))
                      done
                      echo "‚ö†Ô∏è Warning: $url not ready after $max_attempts attempts"
                      return 1
                  }

                  # Wait for critical services (non-blocking warnings for others)
                  wait_for_service "http://localhost:5100" || true  # User Service
                  wait_for_service "http://localhost:5200" || true  # Project Service
                  wait_for_service "http://localhost:5300" || true  # Schedule Service
                  wait_for_service "http://localhost:5500" || true  # Tasks Service
                  wait_for_service "http://localhost:4000" || true  # Manage-Task Service
                  wait_for_service "http://localhost:4100" || true  # Manage-Project Service
                  wait_for_service "http://localhost:4500" || true  # Notify User Service
                  wait_for_service "http://localhost:8000/user" || true  # Kong Gateway

                  echo "Services health check complete!"

            - name: Run Go integration tests with coverage
              working-directory: ./test/integration
              run: |
                  go test -v -race -covermode=atomic -coverprofile=coverage.out

            - name: Verify coverage file exists
              working-directory: ./test/integration
              run: |
                  if [ -f coverage.out ]; then
                      echo "‚úÖ Coverage file exists"
                      echo "Coverage file size: $(wc -l < coverage.out) lines"
                      head -5 coverage.out || true
                  else
                      echo "‚ö†Ô∏è Warning: coverage.out not found"
                  fi

            - name: Upload Go coverage to Coveralls (parallel)
              uses: shogo82148/actions-goveralls@v1
              with:
                  path-to-profile: test/integration/coverage.out
                  parallel: true
                  flag-name: go
              env:
                  COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
              continue-on-error: true

            - name: Container Cleanup
              if: always()
              run: |
                  docker compose down --volumes --remove-orphans
                  docker system prune -f
